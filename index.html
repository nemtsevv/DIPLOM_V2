<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GPS-—Ç—Ä–µ–∫–µ—Ä by NemtesevV Org's</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css">
<style>
  body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f8f9fa;
    transition: background-color 0.3s ease;
  }
  
  #map {
    height: 100vh;
    width: 100%;
    border-radius: 15px;
    box-shadow: 0px 10px 30px rgba(0, 0, 0, 0.2);
    overflow: hidden;
  }

  /* –ö–Ω–æ–ø–∫–∏ */
  .button {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    padding: 12px 20px;
    background: linear-gradient(45deg, #007BFF, #0056b3);
    color: white;
    font-size: 18px;
    font-weight: bold;
    border: none;
    border-radius: 12px;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .button:hover { transform: scale(1.05); box-shadow: 0px 6px 15px rgba(0, 0, 0, 0.4); }
  .button:active { transform: scale(0.95); }

  /* –ü–∞–Ω–µ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */
  #infoPanel {
    position: absolute;
    bottom: 80px;
    right: 20px;
    z-index: 1000;
    padding: 12px;
    background-color: rgba(255, 255, 255, 0.85);
    border-radius: 12px;
    font-size: 16px;
    font-weight: bold;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
  }
</style>
</head>
<body>

<button id="toggleRoute" class="button"><i class="fas fa-route"></i> –ú–∞—Ä—à—Ä—É—Ç</button>
<div id="infoPanel">üìç –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–ª–∏: -- –∫–º</div>
<div id="map"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getDatabase, ref, query, limitToLast, onValue, orderByKey } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";
  import L from "https://cdn.skypack.dev/leaflet";
  import "https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDYF_tiHJwmBzHKnrx6v2fH0vvaHVbC_lI",
    authDomain: "diplomv1-76630.firebaseapp.com",
    databaseURL: "https://diplomv1-76630-default-rtdb.firebaseio.com",
    projectId: "diplomv1-76630",
    storageBucket: "diplomv1-76630.firebasestorage.app",
    messagingSenderId: "366758054319",
    appId: "1:366758054319:web:62a9011da0c2462326c75a",
    measurementId: "G-LHB4C8MTRC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const map = L.map('map').setView([52.183239, 28.964365], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '¬© OpenStreetMap'
  }).addTo(map);

  // üîπ –ö–∞—Å—Ç–æ–º–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è —Ç—Ä–µ–∫–µ—Ä–∞ (–∞–≤—Ç–æ–º–æ–±–∏–ª—å)
  const trackerIcon = L.icon({
    iconUrl: 'https://img.icons8.com/?size=100&id=kfRfIRUL7jMk&format=png&color=000000',
    iconSize: [40, 40],
    iconAnchor: [20, 40],
  });

  // üîπ –ö–∞—Å—Ç–æ–º–Ω–∞—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–µ–ª–æ–≤–µ–∫)
  const userIcon = L.icon({
    iconUrl: 'https://img.icons8.com/?size=100&id=x0qTmzjcFRhW&format=png&color=000000',
    iconSize: [30, 30],
    iconAnchor: [15, 30],
  });

  let marker = L.marker([52.183239, 28.964365], { icon: trackerIcon }).addTo(map);
  let userMarker = null;
  let routeControl = null;

  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition((position) => {
      const userLat = position.coords.latitude;
      const userLon = position.coords.longitude;

      if (!userMarker) {
        userMarker = L.marker([userLat, userLon], { icon: userIcon }).addTo(map);
      } else {
        userMarker.setLatLng([userLat, userLon]);
      }

      const distance = haversine(userLat, userLon, marker.getLatLng().lat, marker.getLatLng().lng).toFixed(2);
      document.getElementById('infoPanel').innerHTML = `üìç –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–ª–∏: ${distance} –∫–º`;
    });
  }

  let routeVisible = false;
  document.getElementById('toggleRoute').addEventListener('click', () => {
  if (routeVisible) {
    map.removeControl(routeControl);
    routeVisible = false;
    document.getElementById('toggleRoute').innerHTML = '<i class="fas fa-route"></i> –ú–∞—Ä—à—Ä—É—Ç';
  } else {
    if (userMarker) {
      routeControl = L.Routing.control({
        waypoints: [userMarker.getLatLng(), marker.getLatLng()],
        routeWhileDragging: true,
        lineOptions: { styles: [{ color: 'red', weight: 5 }] },
        createMarker: () => null,
      }).addTo(map);

      routeVisible = true;
      document.getElementById('toggleRoute').innerHTML = '<i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å';

      // üîπ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
      routeControl.on('routesfound', function (e) {
        let route = e.routes[0];
        let totalDistance = (route.summary.totalDistance / 1000).toFixed(2);
        document.getElementById('infoPanel').innerHTML = `üìç –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Ü–µ–ª–∏: ${totalDistance} –∫–º`;

        // üîπ –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –º–∞—Ä—à—Ä—É—Ç–∞
        // route.instructions.forEach((step) => {
        //   step.text = step.text.replace('Turn right', 'üîÑ –ü–æ–≤–µ—Ä–Ω–∏ –Ω–∞–ø—Ä–∞–≤–æ');
        //   step.text = step.text.replace('Turn left', 'üîÑ –ü–æ–≤–µ—Ä–Ω–∏ –Ω–∞–ª–µ–≤–æ');
        //   step.text = step.text.replace('Go straight', '‚û°Ô∏è –î–≤–∏–≥–∞–π—Å—è –ø—Ä—è–º–æ');
        //   step.text = step.text.replace('Head northeast', '–ù–∞–ø—Ä–∞–≤–ª—è–π—Ç–µ—Å—å –Ω–∞ —Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫');
        //   step.text = step.text.replace('Stop', 'üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞');
        // });
      });
    }
  }
});


</script>

</body>
</html>
